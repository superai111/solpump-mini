<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Solpump Mini</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@solana/web3.js@1.95.2/lib/index.iife.min.js"></script>

<style>
body{margin:0;background:#0b0f1a;color:#fff;font-family:Arial}
.container{max-width:420px;margin:40px auto;padding:16px}
.card{background:#12182a;border-radius:12px;padding:16px;margin-bottom:16px}
button{width:100%;padding:14px;border-radius:10px;border:none;
background:#00ff9c;font-size:16px;font-weight:bold}
input{width:100%;padding:12px;border-radius:8px;border:none;font-size:16px;margin-top:8px}
.small{font-size:14px;opacity:.8;margin-top:6px}
</style>
</head>

<body>
<div class="container">
<h2>ðŸš€ Solpump Mini</h2>

<div class="card">
<button onclick="connectWallet()">Connect Phantom Wallet</button>
<div id="wallet" class="small"></div>
</div>

<div class="card">
<h3>Buy Points</h3>
<div class="small">1 SOL = 1000 points (min 0.01 SOL)</div>
<input id="solInput" type="number" step="0.001" placeholder="Enter SOL (ex: 0.06)">
<div id="points" class="small"></div>
<button onclick="buyPoints()">Buy Points</button>
</div>

<div class="card">
<h3>Statistics</h3>
<div>Total Prize Pool: <span id="prize">0</span> SOL</div>
</div>
</div>

<script>
/* ===== CONFIG ===== */
const SYSTEM_WALLET = "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ";

const SUPABASE_URL = "https://twnovzaygfpxydkzwzsd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3bm92emF5Z2ZweHlka3p3enNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTU2MzEsImV4cCI6MjA4MTU5MTYzMX0.T5s5vqGPDXYqpr1kA85lh-2VF_rUdXg8YCutq0QZ5j4";

/* ===== INIT ===== */
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const { Connection, PublicKey, Transaction, SystemProgram, LAMPORTS_PER_SOL } = solanaWeb3;
const connection = new Connection("https://api.mainnet-beta.solana.com");

let wallet = null;

/* ===== WALLET ===== */
async function connectWallet(){
  if(!window.solana || !window.solana.isPhantom){
    alert("Open this site in Phantom Browser");
    return;
  }
  const res = await window.solana.connect();
  wallet = res.publicKey;
  document.getElementById("wallet").innerText =
    wallet.toString().slice(0,4)+"..."+wallet.toString().slice(-4);
}

/* ===== BUY POINTS ===== */
async function buyPoints(){
  if(!wallet){ alert("Connect wallet first"); return; }

  const sol = parseFloat(document.getElementById("solInput").value);
  if(isNaN(sol) || sol < 0.01){ alert("Min 0.01 SOL"); return; }

  const points = Math.floor(sol * 1000);
  document.getElementById("points").innerText = points + " points";

  const tx = new Transaction().add(
    SystemProgram.transfer({
      fromPubkey: wallet,
      toPubkey: new PublicKey(SYSTEM_WALLET),
      lamports: sol * LAMPORTS_PER_SOL
    })
  );

  tx.feePayer = wallet;
  tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

  const signed = await window.solana.signTransaction(tx);
  await connection.sendRawTransaction(signed.serialize());

  await supabase.from("users").upsert({
    wallet: wallet.toString(),
    points: points,
    total_paid_sol: sol
  });

  loadStats();
  alert("Success!");
}

/* ===== STATS ===== */
async function loadStats(){
  const { data } = await supabase
    .from("users")
    .select("total_paid_sol");

  let total = 0;
  data?.forEach(r => total += Number(r.total_paid_sol || 0));
  document.getElementById("prize").innerText = (total * 0.5).toFixed(3);
}

loadStats();
</script>
</body>
  </html>
