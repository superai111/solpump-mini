<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Solpump Mini</title>

<style>
body {
  background: radial-gradient(circle at top, #0b1a3a, #050814);
  color: #fff;
  font-family: Arial;
  margin: 0;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
.card {
  background: #0c1635;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 14px;
}
.multiplier {
  font-size: 56px;
  font-weight: bold;
  text-align: center;
}
button {
  width: 100%;
  padding: 14px;
  border-radius: 12px;
  border: none;
  background: #2cffb3;
  font-size: 18px;
  font-weight: bold;
}
button.stop {
  background: #222;
  color: #999;
}
input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  margin-bottom: 8px;
}
.history {
  display: flex;
  gap: 6px;
  overflow-x: auto;
}
.history span {
  background: #15245a;
  padding: 6px 10px;
  border-radius: 8px;
}
.warn {
  color: #ff6b6b;
  margin-top: 8px;
}
</style>

<!-- Solana Web3 -->
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
</head>

<body>
<div class="container">

<h2>üöÄ Solpump Mini</h2>

<div class="card">
  <button onclick="connectWallet()">Connect Phantom Wallet</button>
  <div id="wallet"></div>
</div>

<div class="card">
  <div class="history" id="history"></div>
</div>

<div class="card">
  <div class="multiplier" id="display">1.00x</div>

  <input id="bet" type="number" placeholder="Bet points">
  <input id="auto" type="number" step="0.01" placeholder="Auto Cashout">

  <div class="warn" id="warn"></div>

  <button onclick="startRound()">START</button>
  <button class="stop" onclick="cashout()">STOP</button>

  <p>Your Points: <b id="points">0</b></p>

  <button onclick="buyPoints()">N·∫†P POINT (SOL)</button>
</div>

</div>

<script>
/* ================== WALLET & SOL ================== */
const SYSTEM_WALLET = "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ";
const connection = new solanaWeb3.Connection(
  solanaWeb3.clusterApiUrl("mainnet-beta"),
  "confirmed"
);

let wallet = null;

/* ================== GAME STATE ================== */
let userPoints = Number(localStorage.getItem("userPoints") || 1000);

let liveMultiplier = 1.0;
let crashPoint = 0;

let running = false;
let crashed = false;
let exited = false;

let bet = 0;
let auto = null;

let interval = null;
let roundStartTime = 0;
const MIN_RUN_TIME = 600; // ms

updatePoints();

/* ================== WALLET ================== */
async function connectWallet() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("Vui l√≤ng m·ªü trang b·∫±ng Phantom Wallet");
    return;
  }
  const r = await window.solana.connect();
  wallet = r.publicKey.toString();
  document.getElementById("wallet").innerText =
    "Wallet: " + wallet.slice(0,4) + "..." + wallet.slice(-4);
}

/* ================== GAME LOGIC ================== */
function genCrash() {
  const r = Math.random();
  if (r < 0.55) return 1 + Math.random() * 0.4;
  if (r < 0.8) return 1.4 + Math.random() * 1.4;
  return 2.8 + Math.random() * 6;
}

function startRound() {
  if (running) return;

  bet = parseInt(document.getElementById("bet").value);
  auto = parseFloat(document.getElementById("auto").value) || null;

  if (!bet || bet <= 0) {
    warn.innerText = "Vui l√≤ng nh·∫≠p s·ªë point c∆∞·ª£c";
    return;
  }

  if (bet > userPoints) {
    warn.innerText = "‚ùó S·ªë point kh√¥ng ƒë·ªß, b·∫°n c·∫ßn n·∫°p th√™m";
    return;
  }

  warn.innerText = "";

  userPoints -= bet;
  savePoints();

  liveMultiplier = 1.0;
  crashPoint = genCrash();

  running = true;
  crashed = false;
  exited = false;

  roundStartTime = Date.now();
  updateDisplay();

  interval = setInterval(loop, 30);
}

function loop() {
  if (!running || crashed) return;

  const SPEED = 0.035; // ch·∫°y ƒë·ªÅu ‚Äì nhanh h∆°n
  if (Math.random() < 0.05) return;

  liveMultiplier += SPEED;
  updateDisplay();

  if (!exited && auto && liveMultiplier >= auto) {
    cashout();
  }

  if (
    Date.now() - roundStartTime >= MIN_RUN_TIME &&
    liveMultiplier >= crashPoint
  ) {
    crash();
  }
}

function cashout() {
  if (!running || exited || crashed) return;
  exited = true;
  const win = Math.floor(bet * liveMultiplier);
  userPoints += win;
  savePoints();
}

function crash() {
  crashed = true;
  running = false;
  clearInterval(interval);

  updateDisplay(crashPoint);
  addHistory(crashPoint);

  setTimeout(() => {
    liveMultiplier = 1.0;
    updateDisplay();
  }, 1200);
}

/* ================== UI HELPERS ================== */
function updateDisplay(val) {
  document.getElementById("display").innerText =
    (val ?? liveMultiplier).toFixed(2) + "x";
}

function updatePoints() {
  document.getElementById("points").innerText = userPoints;
}

function savePoints() {
  localStorage.setItem("userPoints", userPoints);
  updatePoints();
}

function addHistory(v) {
  const h = document.getElementById("history");
  const s = document.createElement("span");
  s.innerText = v.toFixed(2) + "x";
  s.style.background = v < 1.3 ? "#7a1c1c" : "#1c7a52";
  h.prepend(s);
}

/* ================== BUY POINTS WITH SOL ================== */
async function buyPoints() {
  if (!wallet) {
    alert("B·∫°n c·∫ßn k·∫øt n·ªëi v√≠ Phantom tr∆∞·ªõc");
    return;
  }

  const solAmount = Number(prompt("Nh·∫≠p s·ªë SOL mu·ªën n·∫°p (t·ªëi thi·ªÉu 0.01):"));
  if (!solAmount || solAmount < 0.01) return;

  try {
    const tx = new solanaWeb3.Transaction().add(
      solanaWeb3.SystemProgram.transfer({
        fromPubkey: window.solana.publicKey,
        toPubkey: new solanaWeb3.PublicKey(SYSTEM_WALLET),
        lamports: solAmount * solanaWeb3.LAMPORTS_PER_SOL
      })
    );

    tx.feePayer = window.solana.publicKey;
    const { blockhash } = await connection.getLatestBlockhash();
    tx.recentBlockhash = blockhash;

    const signed = await window.solana.signTransaction(tx);
    const sig = await connection.sendRawTransaction(signed.serialize());
    await connection.confirmTransaction(sig, "confirmed");

    // QUY ƒê·ªîI: 0.01 SOL = 10 POINT  ‚Üí 1 SOL = 1000 POINT
    const earned = solAmount * 1000;
    userPoints += earned;
    savePoints();

    alert("N·∫°p th√†nh c√¥ng +" + earned + " point");

  } catch (e) {
    alert("Giao d·ªãch th·∫•t b·∫°i");
  }
}
</script>

</body>
</html>
