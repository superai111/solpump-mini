<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Solpump Mini</title>

  <!-- Solana + Supabase -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: linear-gradient(180deg,#050b18,#02040a);
      color: #fff;
    }
    .container {
      max-width: 420px;
      margin: 40px auto;
      padding: 20px;
    }
    .card {
      background: #0b1220;
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 30px rgba(0,0,0,.4);
    }
    h1 { text-align:center; margin-bottom:20px }
    button {
      width:100%;
      padding:14px;
      border-radius:10px;
      border:none;
      background:#00ffa3;
      font-size:16px;
      font-weight:bold;
      cursor:pointer;
    }
    input {
      width:100%;
      padding:12px;
      border-radius:8px;
      border:none;
      margin:10px 0;
      font-size:16px;
    }
    .muted { color:#9aa4b2; font-size:14px }
  </style>
</head>

<body>
<div class="container">

  <h1>ðŸš€ Solpump Mini</h1>

  <div class="card">
    <button onclick="connectWallet()">Connect Phantom Wallet</button>
    <p id="wallet" class="muted"></p>
  </div>

  <div class="card" id="buyBox" style="display:none">
    <h3>Buy Points</h3>
    <p class="muted">1 SOL = 1000 points (min 0.01 SOL)</p>
    <input id="solAmount" placeholder="Enter SOL (ex: 0.06)" />
    <p id="pointsPreview"></p>
    <button onclick="buyPoints()">Buy Points</button>
  </div>

  <div class="card">
    <h3>Statistics</h3>
    <p>Total Prize Pool: <b><span id="prize">0</span> SOL</b></p>
  </div>

</div>

<script>
/* ===== CONFIG ===== */
const SYSTEM_WALLET = "H2yVMrEbexHFdsAMFQtBY3Lp3BBz6cu6VVJwyiommqxZ";

const SUPABASE_URL = "https://twnovzaygfpxydkzwzsd.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR3bm92emF5Z2ZweHlka3p3enNkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMTU2MzEsImV4cCI6MjA4MTU5MTYzMX0.T5s5vqGPDXYqpr1kA85lh-2VF_rUdXg8YCutq0QZ5j4";

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const connection = new solanaWeb3.Connection(solanaWeb3.clusterApiUrl("mainnet-beta"));

let wallet = null;

/* ===== WALLET ===== */
async function connectWallet() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("Open this site inside Phantom browser");
    return;
  }
  const res = await window.solana.connect();
  wallet = res.publicKey.toString();
  document.getElementById("wallet").innerText = wallet;
  document.getElementById("buyBox").style.display = "block";
}

/* ===== POINT PREVIEW ===== */
document.getElementById("solAmount").addEventListener("input", e => {
  const sol = parseFloat(e.target.value || 0);
  document.getElementById("pointsPreview").innerText =
    sol >= 0.01 ? `Points: ${Math.floor(sol * 1000)}` : "";
});

/* ===== BUY POINTS ===== */
async function buyPoints() {
  const sol = parseFloat(document.getElementById("solAmount").value);
  if (!wallet || sol < 0.01) return alert("Invalid");

  const tx = new solanaWeb3.Transaction().add(
    solanaWeb3.SystemProgram.transfer({
      fromPubkey: window.solana.publicKey,
      toPubkey: new solanaWeb3.PublicKey(SYSTEM_WALLET),
      lamports: sol * solanaWeb3.LAMPORTS_PER_SOL
    })
  );

  tx.feePayer = window.solana.publicKey;
  tx.recentBlockhash = (await connection.getLatestBlockhash()).blockhash;

  const signed = await window.solana.signTransaction(tx);
  await connection.sendRawTransaction(signed.serialize());

  const points = Math.floor(sol * 1000);

  await supabase.from("users").upsert({
    wallet,
    points,
    total_paid_sol: sol
  }, { onConflict: "wallet" });

  loadStats();
}

/* ===== STATS ===== */
async function loadStats() {
  const { data } = await supabase
    .from("users")
    .select("total_paid_sol");

  const total = data.reduce((a,b)=>a+Number(b.total_paid_sol||0),0);
  document.getElementById("prize").innerText = (total * 0.5).toFixed(3);
}

loadStats();
</script>
</body>
  </html>
