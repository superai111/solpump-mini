<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Solpump Mini</title>

<style>
body {
  margin: 0;
  background: radial-gradient(circle at top, #0b1a3a, #050814);
  font-family: Arial, sans-serif;
  color: #fff;
}
.container {
  max-width: 420px;
  margin: auto;
  padding: 16px;
}
.card {
  background: #0c1635;
  border-radius: 14px;
  padding: 16px;
  margin-bottom: 16px;
}
button {
  width: 100%;
  padding: 14px;
  font-size: 18px;
  border: none;
  border-radius: 12px;
  background: #2cffb3;
  font-weight: bold;
}
button.stop {
  background: #222;
  color: #aaa;
}
input {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: none;
  margin-bottom: 8px;
  font-size: 16px;
}
.multiplier {
  font-size: 56px;
  text-align: center;
  font-weight: bold;
}
.history {
  display: flex;
  gap: 6px;
  overflow-x: auto;
}
.history span {
  padding: 6px 10px;
  border-radius: 8px;
  background: #15245a;
}
</style>
</head>

<body>
<div class="container">

<h2>ðŸš€ Solpump Mini</h2>

<div class="card">
  <button onclick="connectWallet()">Connect Phantom Wallet</button>
  <div id="wallet"></div>
</div>

<div class="card">
  <div class="history" id="history"></div>
</div>

<div class="card">
  <!-- HIá»‚N THá»Š Káº¾T QUáº¢ CUá»I VÃ’NG -->
  <div class="multiplier" id="roundResult">1.00x</div>

  <input id="bet" type="number" placeholder="Bet points (ex: 50)" />
  <input id="auto" type="number" step="0.01" placeholder="Auto Cashout (ex: 2.0)" />

  <button onclick="startRound()">START</button>
  <button class="stop" onclick="playerCashout()">STOP</button>

  <p>Your Points: <b id="points">1000</b></p>
</div>

</div>

<script>
/* ---------------- STATE ---------------- */
let wallet = null;
let userPoints = 1000;

let betPoints = 0;
let autoCashout = null;

let running = false;
let crashed = false;
let playerExited = false;

let currentMultiplier = 1.0;
let crashPoint = 0;
let interval = null;

/* ---------------- WALLET ---------------- */
async function connectWallet() {
  if (!window.solana || !window.solana.isPhantom) {
    alert("Open inside Phantom browser");
    return;
  }
  const res = await window.solana.connect();
  wallet = res.publicKey.toString();
  document.getElementById("wallet").innerText =
    "Wallet: " + wallet.slice(0,4) + "..." + wallet.slice(-4);
}

/* ---------------- GAME LOGIC ---------------- */
function generateCrashPoint() {
  const r = Math.random();
  if (r < 0.5) return 1 + Math.random() * 0.35;     // crash sá»›m nhiá»u
  if (r < 0.8) return 1.35 + Math.random() * 1.2;
  return 2.5 + Math.random() * 5;
}

function startRound() {
  if (running) return;

  betPoints = parseInt(document.getElementById("bet").value);
  if (!betPoints || betPoints <= 0 || betPoints > userPoints) {
    alert("Invalid bet");
    return;
  }

  autoCashout = parseFloat(document.getElementById("auto").value) || null;

  userPoints -= betPoints;
  updatePoints();

  currentMultiplier = 1.0;
  crashPoint = generateCrashPoint();

  running = true;
  crashed = false;
  playerExited = false;

  interval = setInterval(gameLoop, 25);
}

function gameLoop() {
  if (crashed) return;

  let speed;
  if (currentMultiplier < 1.4) speed = 0.02;
  else if (currentMultiplier < 2) speed = 0.028;
  else if (currentMultiplier < 3) speed = 0.04;
  else speed = 0.06;

  // fake lag
  if (Math.random() < 0.07) return;

  currentMultiplier += speed;

  // auto cashout
  if (!playerExited && autoCashout && currentMultiplier >= autoCashout) {
    playerCashout();
  }

  // crash
  if (currentMultiplier >= crashPoint) {
    endRound();
  }
}

function playerCashout() {
  if (!running || playerExited || crashed) return;

  playerExited = true;
  const win = Math.floor(betPoints * currentMultiplier);
  userPoints += win;
  updatePoints();
}

function endRound() {
  crashed = true;
  running = false;
  clearInterval(interval);

  document.getElementById("roundResult").innerText =
    crashPoint.toFixed(2) + "x";

  addHistory(crashPoint);

  // reset sau 1s
  setTimeout(() => {
    currentMultiplier = 1.0;
  }, 1000);
}

/* ---------------- UI ---------------- */
function updatePoints() {
  document.getElementById("points").innerText = userPoints;
}

function addHistory(mult) {
  const h = document.getElementById("history");
  const s = document.createElement("span");
  s.innerText = mult.toFixed(2) + "x";
  s.style.background = mult < 1.3 ? "#6f1d1d" : "#1d6f42";
  h.prepend(s);
}
</script>

</body>
</html>
